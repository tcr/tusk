extends ./layout.jade

block style
  style.
    html, body { margin: 0; padding: 0; flex-direction: column; }
    html { width: 100%; height: 100%; }
    html, body, #body { display: flex; flex-grow: 1; }
    #body { flex-direction: row; flex-grow: 1; }
    #job-info { min-width: 300px; }
    #job-log { background: #000; flex-grow: 1; display: flex; flex-direction: column; }
    #job-log iframe { width: 100%; flex-grow: 1; display: block; border: none; }

block body
  section#job-info
    h2 Job ##{id} <span id="loading"></span>

    if job.end
      p
        | Elapsed time: 
        = humanizeDuration(Math.floor((job.end - job.start) / 1e3)*1e3)

    if job.finished && !job.error
      p
        a(href='artifact')
          | [ Download build artifact ]

    form(action="./cancel", method="post")
      button(type="submit") Cancel job

  section#job-log
    iframe(src="log", id="log", autofocus)

  script.
    var list = ['⠋','⠙','⠹','⠸','⠼','⠴','⠦','⠧','⠇','⠏'], id = 0
    var loadingnode = document.querySelector('#loading');
    function loop () {
      id++;
      var char = list[id % list.length];
      loadingnode.innerText = char;
    }
    // var intid = setInterval(loop, 100);
    document.querySelector('#log').addEventListener('load', function () {
      clearInterval(intid);
      alive = false;
      document.querySelector('#loading').innerText = '';
    }, false);

    /*
    var deadid = null, alive = true;
    function timeout () {
      if (!alive) {
        return;
      }
      if (deadid != null) {
        clearTimeout(deadid);
      }
      deadid = setTimeout(function () {
        if (!alive) {
          return;
        }
        console.log('Timeout, reloading...');
        document.querySelector('#log').contentWindow.location.reload(true);
      }, 10*1000);
    }
    window.addEventListener('message', function (message) {
      if (message.data == 'ping') {
        timeout();
      }
    }, false);
    */
